//copilot must hold button to turn and shoot; if presses 1 (just in case), will exit loop; 3 will reset(before shooting again)
//actually use drive encoders to ensure ratio of speed is correct  && launch
//cam
//see DOGP and fireMuhLazer for other changes to be made
//make warning if out of range

#include "WPILib.h"//include main lib
#include "nivision.h"

#define IO (DriverStation::GetInstance()->GetEnhancedIO())//driver station input/output

AxisCamera &camera = AxisCamera::GetInstance();//live feed to driverstation instead of flawed nvision stuff
ColorImage image(IMAQ_IMAGE_RGB);//create an image


class ironsInTheFire : public SimpleRobot
{
	//declarations -- extra jag and gyro for balance?
	Encoder LTopEnc, LBotEnc;//launch system   --  Lazer reference XD
	Joystick pilot, copilot;
	CANJaguar lefty, righty, leftyB, rightyB, intake, lift, LTop, LBot, arm;
	signed char negate, fPS;//find max FPS w/out slowing rob then use that as base
							//increase if turning fast and needed
	double distance;
						//distance will be a guessed distance from target via the camera code
	float decrement;//lower as appr. target
					//begins at full until within a range; then increasing rate of decrimate
public:
	ironsInTheFire(void)://Vriska reference and class name also
		
		pilot(1),//below are constructors and such
		copilot(2),//pilot and copilot are in USB ports (adjustable via driverstation)
		
		lefty(1),//here until  V
		righty(2),
		arm(3),
		leftyB(4),
		rightyB(5),
		intake(6),
		lift(7),
		LTop(8),
		LBot(9),//HERE are jags that need to be in the order in which they are plugged in
		
		LTopEnc(1,2),//encoders -- 2 channels each;  add drive encoders -- 2 or 4?
		LBotEnc(3,4)
	
		{
			fPS = 6;//later will change in loop depending on factors explained above
			camera.WriteMaxFPS(fPS);//needs to be called after above
			camera.WriteBrightness(0);
			camera.WriteWhiteBalance(AxisCamera::kWhiteBalance_Automatic);//best for now; redo at comp
			camera.WriteResolution(AxisCamera::kResolution_320x240);//higher = more accurate but slower
			
			decrement = 1;//value to slow jags when firing
			negate=1;//changes orrientation of drive
			
			lefty.ChangeControlMode(CANJaguar::kPercentVbus);//constructs canJags
			righty.ChangeControlMode(CANJaguar::kPercentVbus);
			leftyB.ChangeControlMode(CANJaguar::kPercentVbus);
			rightyB.ChangeControlMode(CANJaguar::kPercentVbus);
			intake.ChangeControlMode(CANJaguar::kPercentVbus);
			lift.ChangeControlMode(CANJaguar::kPercentVbus);
			LTop.ChangeControlMode(CANJaguar::kPercentVbus);
			LBot.ChangeControlMode(CANJaguar::kPercentVbus);
			
			LTopEnc.Reset();//set encoder to 0
			LBotEnc.Reset();
			LTopEnc.Start();//start encoder
			LBotEnc.Start();
			//add drive encoders
		}
	
	void DOGP(void)//%reference
	{
		camera.GetImage(&image);//gets image from cam
		BinaryImage* binImg = image.ThresholdRGB(192, 256, 192, 156, 192, 256);//make binary image; set param
																				//for target
		vector<ParticleAnalysisReport>* particles = binImg->GetOrderedParticleAnalysisReports();
								//a particle is a target
								//reports return 'scores'
		
		//with cam, set distance still to do
		
		//
		for(UINT32 x = 0; x < particles->size() /*and right or left jags movin(check via encoders)*/; x++)
		{//goes acrossed particle
			
			ParticleAnalysisReport& par = (*particles)[x];
			
			if (par.center_mass_x_normalized > -.3  && par.center_mass_x_normalized < .3)//particle is a double
			{
				decrement = par.center_mass_x_normalized*2;//so as near target slows down
			}
			else
				decrement = 1;
			
			if(par.center_mass_x_normalized > 0)//right; 
			{
				righty.Set(0);
				rightyB.Set(0);
				lefty.Set(decrement);
				leftyB.Set(decrement);
			}//find center
			else if(par.center_mass_x_normalized < 0)//left
			{
				lefty.Set(0);
				leftyB.Set(0);
				righty.Set(decrement);
				rightyB.Set(decrement);
			}
			if (copilot.GetRawButton(1))
			{}//escape
		}
	}
	
	void fireMuhLazer(void)//&reference
	{
		//move balls up  --  will require a wait
		//turn off ltop and lbot and lift and intake
	}
	
	void creep(void)//Vriska reference and drive system -- system similar to a car
	{				
		if (pilot.GetY() > 0 && pilot.GetX() >= 0)//forward right
		{
			lefty.Set(pilot.GetY() * negate * decrement);//left motors full
			leftyB.Set(pilot.GetY() * negate * decrement);//left motors full
			righty.Set(( pilot.GetY() - pilot.GetX() * 2 ) * negate * decrement);//right motors full dec by twiceX abs X
			rightyB.Set(( pilot.GetY() - pilot.GetX() * 2 ) * negate * decrement);
		}//(so up to x = 0 right rev and when y negative, backward curve)
		else if (pilot.GetY() < 0 && pilot.GetX() > 0)//backward left
		{
			righty.Set(pilot.GetY() * negate * -1 * decrement);
			rightyB.Set(pilot.GetY() * negate * -1 * decrement);
			lefty.Set((pilot.GetY() - pilot.GetX() * 2) * negate * decrement);
			leftyB.Set((pilot.GetY() - pilot.GetX() * 2) * negate * decrement);
		}
		else if (pilot.GetY() > 0 && pilot.GetX() <= 0)//forward left
		{
			righty.Set(pilot.GetY() * negate * decrement);
			rightyB.Set(pilot.GetY() * negate * decrement);
			lefty.Set((pilot.GetX() * 2 + pilot.GetY()) * negate * decrement);
			leftyB.Set((pilot.GetX() * 2 + pilot.GetY()) * negate * decrement);
		}
		else if (pilot.GetY() < 0 && pilot.GetX() < 0)//back right
		{
			lefty.Set(pilot.GetY() * negate * -1 * decrement);//left full back
			leftyB.Set(pilot.GetY() * negate * -1 * decrement);//left full back
			righty.Set(( pilot.GetY() + pilot.GetX() * 2 ) * negate * decrement);//right morots full dec by twice abs X
			rightyB.Set(( pilot.GetY() + pilot.GetX() * 2 ) * negate * decrement);
		}
		else
		{
			righty.Set(pilot.GetY() *negate * decrement);
			rightyB.Set(pilot.GetY() *negate * decrement);
			lefty.Set(pilot.GetY() *negate * decrement);
			leftyB.Set(pilot.GetY() *negate * decrement);
		}
	}
	
	void Autonomous(void)
	{
		GetWatchdog().Kill();
		while (IsAutonomous())
		{
			DOGP();//aim and shoot
			fireMuhLazer();
		}
	}
	void OperatorControl(void)
	{
		GetWatchdog().Kill();
		while (IsOperatorControl())
		{
				
			if (copilot.GetTop())//for moving platform arm
				arm.Set(-1);
			else if (copilot.GetTrigger())
				arm.Set(1);
			else
				arm.Set(0);
			
			if (copilot.GetRawButton(2))//aim and set jag power
			{
				DOGP();//aim and shoot
				fireMuhLazer();
			}
			else if (copilot.GetRawButton(3))
				decrement = 1;
			
			intake.Set(copilot.GetTwist());//take in balls

			if (pilot.GetRawButton(1)){negate *= -1;}//to reverse creep
			decrement = 1;//because full power for driver when not auto aiming
			creep();//drive system
			
		}
		LTopEnc.Stop();//stop encoders
		LBotEnc.Stop();
		//include drive encoders
	}
};

START_ROBOT_CLASS(ironsInTheFire);//called by driverstation
